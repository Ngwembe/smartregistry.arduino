// *************** OLED SETUP *****************

#include <SPI.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#include <ArduinoJson.h>

#define OLED_RESET LED_BUILTIN
Adafruit_SSD1306 display(OLED_RESET);

#define NUMFLAKES 10
#define XPOS 0
#define YPOS 1
#define DELTAY 2

#define LOGO16_GLCD_HEIGHT 16 
#define LOGO16_GLCD_WIDTH  16 
static const unsigned char PROGMEM logo16_glcd_bmp[] =
{ B00000000, B11000000,
  B00000001, B11000000,
  B00000001, B11000000,
  B00000011, B11100000,
  B11110011, B11100000,
  B11111110, B11111000,
  B01111110, B11111111,
  B00110011, B10011111,
  B00011111, B11111100,
  B00001101, B01110000,
  B00011011, B10100000,
  B00111111, B11100000,
  B00111111, B11110000,
  B01111100, B11110000,
  B01110000, B01110000,
  B00000000, B00110000 };

//  **********************  CUSTOM BITMAP ****************************

const unsigned char thumbs_up [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 
  0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 
  0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xc0, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 
  0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0x80, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 
  0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 
  0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 
  0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 
  0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 
  0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 
  0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 
  0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 
  0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 
  0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 
  0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 
  0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
  0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
  0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
  0x0f, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
  0x0f, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
  0x0f, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
  0x0f, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
  0x0f, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
  0x0f, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfc, 0x00, 0x0f, 0xff, 0xff, 0xf0, 
  0x1f, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xff, 0xf0, 
  0x0f, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xff, 0xf0, 
  0x0f, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xff, 0xf0, 
  0x0f, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xff, 0xf0, 
  0x0f, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xff, 0xf0, 
  0x0f, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xff, 0xf0, 
  0x0f, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xff, 0xf0, 
  0x07, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xff, 0xe0, 
  0x03, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xff, 0xc0, 
  0x01, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xff, 0x80, 
  0x01, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xff, 0x80, 
  0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xff, 0x00, 
  0x00, 0x7f, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xfe, 0x00, 
  0x00, 0x3f, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xfc, 0x00, 
  0x00, 0x3f, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xfc, 0x00, 
  0x00, 0x0f, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x07, 0xff, 0xf0, 0x00, 
  0x00, 0x0f, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xfc, 0x00, 0x07, 0xff, 0xf0, 0x00, 
  0x00, 0x03, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 
  0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 
  0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 
  0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 
  0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 
  0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};


static const unsigned char thumbs_down[] PROGMEM  =
{ 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x03, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x07, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xf0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x3f, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0x80, 0x00, 0x00, 
  0x00, 0x00, 0x07, 0xff, 0xc0, 0x00, 0x00, 0xff, 0xfe, 0x00, 0x00, 0x03, 0xff, 0xe0, 0x00, 0x00, 
  0x00, 0x00, 0x1f, 0xfe, 0x40, 0x00, 0x7f, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x7f, 0xf8, 0x00, 0x00, 
  0x00, 0x00, 0x3f, 0xf0, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x0f, 0xfe, 0x00, 0x00, 
  0x00, 0x00, 0xff, 0xe0, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x03, 0xff, 0x00, 0x00, 
  0x00, 0x03, 0xff, 0x40, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x0a, 0xff, 0xc0, 0x00, 
  0x00, 0x07, 0xfe, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x7f, 0xe0, 0x00, 
  0x00, 0x0f, 0xfc, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x1f, 0xf8, 0x00, 
  0x00, 0x3f, 0xf0, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x07, 0xfc, 0x00, 
  0x00, 0x3f, 0xe0, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x03, 0xfe, 0x00, 
  0x00, 0x7f, 0xc0, 0x1f, 0xff, 0xf3, 0xff, 0xc0, 0x00, 0x3f, 0xff, 0xff, 0xf0, 0x01, 0xff, 0x00, 
  0x00, 0xff, 0x00, 0x3f, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf8, 0x00, 0xff, 0x80, 
  0x01, 0xfe, 0x00, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xfe, 0x00, 0x3f, 0xc0, 
  0x03, 0xfe, 0x00, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0x00, 0x3f, 0xc0, 
  0x03, 0xfe, 0x01, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0x80, 0x3f, 0xe0, 
  0x07, 0xfc, 0x03, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xc0, 0x1f, 0xe0, 
  0x07, 0xf8, 0x07, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xc0, 0x0f, 0xf0, 
  0x0f, 0xf0, 0x0f, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xe0, 0x0f, 0xf0, 
  0x0f, 0xf0, 0x0f, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xf0, 0x07, 0xf8, 
  0x1f, 0xf0, 0x1f, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xf0, 0x07, 0xf8, 
  0x1f, 0xe0, 0x1f, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xf0, 0x07, 0xf8, 
  0x1f, 0xe0, 0x1f, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xf8, 0x03, 0xf8, 
  0x1f, 0xe0, 0x1f, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xf8, 0x03, 0xf8, 
  0x1f, 0xe0, 0x1f, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xf8, 0x07, 0xf8, 
  0x1f, 0xf0, 0x1f, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xf8, 0x03, 0xf8, 
  0x1f, 0xe0, 0x1f, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf8, 0x03, 0xf8, 
  0x1f, 0xe0, 0x1f, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xf8, 0x07, 0xf8, 
  0x1f, 0xe0, 0x1f, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xf0, 0x07, 0xf8, 
  0x0f, 0xf0, 0x1f, 0xff, 0xff, 0xff, 0xf0, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x17, 0xf8, 
  0x07, 0xf8, 0x0f, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x0f, 0xf0, 
  0x07, 0xfc, 0x0f, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x0f, 0xe0, 
  0x07, 0xfc, 0x07, 0xff, 0xff, 0xff, 0xff, 0x80, 0x03, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x1f, 0xe0, 
  0x03, 0xfc, 0x03, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x00, 0xff, 0xff, 0xff, 0xff, 0x80, 0x3f, 0xc0, 
  0x03, 0xfe, 0x01, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0xff, 0xff, 0xff, 0xff, 0x80, 0x3f, 0xc0, 
  0x01, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x7f, 0xff, 0xff, 0xff, 0x00, 0xff, 0x80, 
  0x00, 0xff, 0x80, 0x7f, 0xff, 0xff, 0xff, 0xff, 0x80, 0x7f, 0xff, 0xff, 0xfc, 0x04, 0xff, 0x80, 
  0x00, 0x7f, 0xc0, 0x3f, 0xff, 0xff, 0xff, 0xff, 0x80, 0x7f, 0xff, 0xff, 0xf8, 0x01, 0xfe, 0x00, 
  0x00, 0x3f, 0xc0, 0x1f, 0xff, 0xff, 0xff, 0xff, 0x80, 0x7f, 0xff, 0xff, 0xf0, 0x03, 0xfe, 0x00, 
  0x00, 0x1f, 0xf0, 0x03, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xff, 0xff, 0xff, 0xc0, 0x0f, 0xf8, 0x00, 
  0x00, 0x0f, 0xfc, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x3f, 0xf0, 0x00, 
  0x00, 0x03, 0xfe, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x7f, 0xe0, 0x00, 
  0x00, 0x01, 0xff, 0xc0, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x03, 0xff, 0x80, 0x00, 
  0x00, 0x00, 0xff, 0xe0, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x07, 0xff, 0x00, 0x00, 
  0x00, 0x00, 0x3f, 0xfc, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x1f, 0xfc, 0x00, 0x00, 
  0x00, 0x00, 0x0f, 0xff, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x10, 0x7f, 0xf0, 0x00, 0x00, 
  0x00, 0x00, 0x03, 0xff, 0xe0, 0x00, 0x0f, 0xff, 0xff, 0xe0, 0x00, 0x07, 0xff, 0xc0, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x1f, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xf8, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x03, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xe0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xfe, 0x00, 0x00, 0x5f, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
  
// 'no-signal-8-914869', 128x64px
const unsigned char networkTower [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0x00, 0x00, 0x7f, 0xf0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xc0, 0x01, 0xff, 0xc0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x07, 0xff, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xff, 0xff, 0x00, 0x1f, 0xfc, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x7f, 0xfc, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x03, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x1f, 0xff, 0x80, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x7f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xfc, 0x7f, 0xfe, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xff, 0xc0, 0x00, 0x0f, 0xf8, 0x00, 0x7f, 0xf0, 0x0f, 0xff, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xff, 0x00, 0x01, 0xff, 0xf8, 0x01, 0xff, 0xc0, 0x01, 0xff, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x3c, 0x00, 0x1f, 0xff, 0xf8, 0x07, 0xff, 0xe0, 0x00, 0x7e, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xf0, 0x1f, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xf8, 0x00, 0x7f, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0x00, 0x01, 0xff, 0xc3, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x1f, 0xf8, 0x00, 0x07, 0xff, 0x00, 0x3f, 0xf8, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x1f, 0xe0, 0x00, 0x1f, 0xfc, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x7f, 0xff, 0x00, 0x01, 0xe0, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf0, 0x01, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xc0, 0x00, 0x3f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf0, 0x1f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xc0, 0x7f, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0x00, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x1f, 0xfc, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x3f, 0xe0, 0x00, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x00, 0x7f, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// *************** FINGERPRINT SCANNER SETUP *****************

#include "FPS_GT511C3.h"
#include "SoftwareSerial.h"

// set up software serial pins for Arduino's w/ Atmega328P's
// FPS (TX) is connected to pin 4 (Arduino's Software RX)
// FPS (RX) is connected through a converter to pin 5 (Arduino's Software TX)
FPS_GT511C3 fps(D7, D6); // (Arduino SS_RX = pin 4, Arduino SS_TX = pin 5)



// *************** ESP32 SETUP *****************

#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>
#include <WebSocketsServer.h>

//  HOME WI-FI
const char* ssid     = "XXXXXXXX";
const char* password = "XXXXXXXX"; 

const char* host = "192.168.9.100";

ESP8266WebServer server(80);
WebSocketsServer webSocket = WebSocketsServer(81);
int scheduleId = 0;

void drawOnDisplay(String line) {
    display.setTextSize(2);
    display.setTextColor(WHITE);
    display.setCursor(0,0);
    display.clearDisplay();
    display.println(line);
    display.display();
}

char rootPage[] PROGMEM = 
R"=====(
  <!DOCTYPE html>
<html>

<head>
    <title>Smart Watcher Serverr</title>
    <style>
        .filter-flex-container {
            /*display: flex;*/
            flex-wrap: nowrap;
            align-items: center;
            /*background-color: #451234;*/
        }

        .filter-flex-container>div {
            /*background-color: #f1f1f1;*/
            width: 50%;
            margin: 1%;
            text-align: center;
            line-height: 75px;
            font-size: 30px;
        }

        .container {
            display: flex;
            /* establish flex container */
            flex-direction: column;
            /* make main axis vertical */
            justify-content: center;
            /* center items vertically, in this case */
            align-items: center;
            /* center items horizontally, in this case */
            height: 300px;
        }

        .row {
            display: flex;
            flex-direction: row;
            justify-content: center;
            /* center items horizontally, in this case */
            /*align-items: center;*/
            /* center items vertically, in this case */
            align-items: flex-start;
            height: 300px;
        }

        @media only screen and (max-width: 768px) {

            /* For mobile phones: */
            .row>div {
                width: 100%;
            }
        }
    </style>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            background: url(assets/main-melting-ice.jpg);
            background-size: cover;
        }

        .box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            padding: 40px;
            background: rgba(0, 0, 0, .8);
            box-sizing: border-box;
            box-shadow: rgba(0, 0, 0, .9);
            border-radius: 5%;
        }

        .box h2 {
            margin: 0;
            padding: 0;
            color: #fff;
            text-align: center;
            margin-bottom: 5%;
        }

        .box .inputBox {
            position: relative;
        }

        .box .inputBox input {
            width: 100%;
            padding: 2%;
            font-size: large;
            color: #fff;
            margin-bottom: 5%;
            border: none;
            outline: none;
            background: transparent;
        }

        .box .inputBox label {
            position: absolute;
            top: 0;
            left: 0;
            padding: 5% 0;
            font-size: small;
            color: #fff;
            pointer-events: none;
            transition: .5s;
        }

        .box .inputBox input:focus~label,
        .box .inputBox input:valid~label {
            top: -50%;
            left: 0;
            color: #03a9f4;
            font-size: smaller;
            margin-top: -2%;
        }

        .box input[type="submit"] {
            background: transparent;
            border: none;
            outline: none;
            color: #fff;
            background: #03a9f4;
            padding: 10px 20px;
            cursor: pointer;
            margin-top: 5%;
            border-radius: 10%;
        }
    </style>
    <style>
    .card {
      /* box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
      max-width: 300px;
      margin: auto;
      text-align: center;
      font-family: arial; */
      /* box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
        max-width: 20%;
        margin: 1%;
        text-align: center;
        font-family: arial; */
    
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
        max-width: 100%;
        margin: 1%;
        text-align: center;
        font-family: arial;
        width: 98%;
    }
    
    .price {
      color: grey;
      font-size: smaller;
      margin: 0%;
      margin-top: -10%;
    }
    
    .card h1 {
        font-size: medium;
    }
    
    .row {
        display: flex;
        align-items: center;
        flex-direction: row;
        height: auto;
    }
    
    .online-indicator {
        height: 20px;
        width: 20px;
        background-color: rgb(0, 200, 0);
        /* background-color: #bbb; */
        border-radius: 50%;
        display: inline-block;
        margin: 2%;
    }

    ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }

    select {
      display: grid;
      align-items: center;
      padding: 5%;  
    }
    
    </style>

    <script type="text/javascript">
      
        var webSocket;
        function init() {

        //  webSocket = new WebSocket('ws://' + window.location.hostname + ':81/');
        //  webSocket.onmessage = function (event) {
        //  var data = JSON.parse(event.data);
        //  console.log(data);
        //  authenticateUser((data.sensorId + 1), data.scheduleId);
        //}
                    
            if(navigator.onLine) {
                document.getElementById("subjectsList").style.display = "none";
                document.getElementById("schedulesList").style.display = "none";
                getAllSubjects();

                document.getElementById('loginPage').style.display = "none";
                document.getElementById('mainPage').style.display = "grid";
            }
            else {
                document.getElementById('loginPage').style.display = "grid";
                document.getElementById('mainPage').style.display = "none";
            }

            window.addEventListener('online', (event) => {
                
                //  Loading the Main Page
                document.getElementById("subjectsList").style.display = "none";
                document.getElementById("schedulesList").style.display = "none";
                getAllSubjects();

                document.getElementById('loginPage').style.display = "none";
                document.getElementById('mainPage').style.display = "grid";

            });
            window.addEventListener('offline', (event) => {
                //  Load Login Screen
                document.getElementById('loginPage').style.display = "grid";
                document.getElementById('mainPage').style.display = "none";
            });
        }

        function getAllSchedules() {
          var websiteUrl= //"http://192.168.9.100";
          "http://192.168.4.2";
          var apiPort = ":8970/";
          
            // Getting subjects from the Website
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {

                    webSocket = new WebSocket('ws://' + window.location.hostname + ':81/');
                    webSocket.onmessage = function (event) {
                        var data = JSON.parse(event.data);
                        //console.log(data);
                        authenticateUser((data.sensorId + 1), data.scheduleId);
                    }

                    //  Processing the response from server
                    var schedulesData = JSON.parse(this.responseText); //this.responseText; //

                    if (schedulesData.length > 0) {
                        document.getElementById("subjectsList").style.display = "none";
                        document.getElementById("schedulesList").style.display = "grid";

                        var schedulesList = document.getElementById("schedulesList");
                        schedulesList.addEventListener("change", function () {
                            if (schedulesList.value != 0) {
                                var message = "[" + schedulesList.options[schedulesList.selectedIndex].text + "]" + " attendance will be recorded!!!";
                                alert(message);

                                document.createElement("scheduleDisplay").innerHTML = message;

                                webSocket.send(schedulesList.value);
                                //webSocket.send("{" + "scheduleId" + ":" + schedulesList.value + "}");
                            }
                        });

                        var tempOption = document.createElement("option");
                        tempOption.value = 0;
                        tempOption.text = "===== Please Select Schedule =====";
                        schedulesList.appendChild(tempOption);

                        for (var index = 0; index < schedulesData.length; index++) {
                            console.log({ schedulesData });

                            var option = document.createElement("option");
                            option.value = schedulesData[index].scheduleId;
                            option.text = schedulesData[index].subject.name + "(" + schedulesData[index].subject.code + ")" + " - " + schedulesData[index].scheduleFor;
                            schedulesList.appendChild(option);
                        }
                    }
                    else {
                        document.getElementById("subjectsList").style.display = "grid";
                        document.getElementById("schedulesList").style.display = "none";
                    }
                }
            };
            xhttp.open("GET", websiteUrl +"/api/Schedule/" + subjectsList.value, true);
            xhttp.setRequestHeader('Access-Control-Allow-Origin', '*');
            xhttp.send();
        }

        function getAllSubjects() {
          var websiteUrl= //"http://192.168.9.100";
          "http://192.168.4.2";
          var apiPort = ":8970/";

            // Getting subjects from the Website
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    //document.getElementById("subjectsList").innerHTML = this.responseText;

                    var subjectsList = document.getElementById("subjectsList");
                    subjectsList.addEventListener("change", function () {
                        if (subjectsList.value != 0) {
                            getAllSchedules();
                        }
                    });

                    var tempOption = document.createElement("option");
                    tempOption.value = 0;
                    tempOption.text = "===== Please Select Subject =====";
                    subjectsList.appendChild(tempOption);

                    //  Processing the response from server
                    var subjectsData = JSON.parse(this.responseText);

                    for (var index = 0; index < subjectsData.length; index++) {
                        console.log({ subjectsData });
                        var option = document.createElement("option");
                        option.value = subjectsData[index].Value;
                        option.text = subjectsData[index].Text;
                        subjectsList.appendChild(option);
                    }

                    document.getElementById("subjectsList").style.display = "grid";
                }
            };
            xhttp.open("GET", websiteUrl +"/Subjects/GetAllSubjects", true);
            xhttp.setRequestHeader('Access-Control-Allow-Origin', '*');
            xhttp.send();
        }

        function authenticateUser(sensorId, scheduleId) {
          var websiteUrl= //"http://192.168.9.100";
          "http://192.168.4.2";
          var apiPort = ":8970/";
          
            // Getting subjects from the Website
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var response = JSON.parse(this.responseText);
                    console.log(response, "Results from server ...");

                    if (response.success) {
                        alert("Welcome " + response.fullName + "(" + response.studentNumber + "). You have been successfully captured !!!");

                        var li = document.createElement("li");
                        li.setAttribute('id', response.studentNumber);


                        
//                      li.appendChild(document.createTextNode(response.fullName + " (" + response.studentNumber + ")"));

                        var innerNode = document.createElement("div");
                        innerNode.innerHTML = `<div class="card">
                                          <div class="row">
                                            <span class="online-indicator"></span>
                                            <h1>${response.fullName}</h1>
                                          </div>
                                          <p class="price">${response.studentNumber}</p>
                                        </div>`;
                        
                        li.appendChild(innerNode);      

                        var ul = document.getElementById("present-students");
                        ul.appendChild(li);
                    }
                    else {
                        alert("Sorry, You were not captured successfully! Error:" + response.message);
                    }
                }
                else {
                    alert("Sorry, You were not captured successfully! Error:" + response.message);
                }
            };

            var authParams = JSON.stringify({ sensorId: sensorId, scheduleId: scheduleId });
            var authUrl = websiteUrl+"/Register/RegisterUser";
            //var authUrl = "http://192.168.4.2/Register/RegisterUser";
            //var authUrl = "http://192.168.4.2/Register/RegisterUser/"+ sensorId + "/" + scheduleId;
            //var authUrl = "http://192.168.4.2/Register/RegisterUser?sensorId="+ sensorId.toString() + "&scheduleId=" + scheduleId.toString();

            console.log("SERVER CALL: " + authUrl);
            //console.log("SERVER CALL PARAMS: " + params);

            xhttp.open("POST", authUrl, true);
            xhttp.setRequestHeader('Access-Control-Allow-Origin', '*');
            xhttp.setRequestHeader("Content-type", "application/json; charset=utf-8");
            //xhttp.send();          
            //xhttp.setRequestHeader("Content-length", params.length);
            //xhttp.setRequestHeader("Connection", "close");
            xhttp.send(authParams);
        }
    </script>

</head>

<body onload="javascript:init()">
    <div class="container" id="mainPage" style="display: none;">
        <div class="row">
            <div class="filter-flex-container">
                <div>
                    <h2 style="display:grid;align-items:center;width: max-content;">Select schedule below to record for:</h2>
                    <select id="subjectsList" name="subjectsList" size="1"
                        style="display: flex;align-items: center;"></select>
                    <select id="schedulesList" name="schedulesList" size="1"
                        style="display: flex;align-items: center;"></select>
                </div>
                <div>
                    <h2 style="display:grid;align-items:center;width: max-content;" id="scheduleDisplay"></h2>
                </div>
            </div>
            <div class="filter-flex-container">
                <div style="width: fit-content;margin-left: 10%;padding-right: 10%;">
                    <h2 style="display:grid;align-items:center;width: max-content;">Present Students:</h2>
                    <ul id="present-students"></ul>
                </div>
            </div>
        </div>            
    </div>  
    
    <div class="box" id="loginPage" style="display: none;">
        <h2>Welcome to Smart Watcher</h2>
        <h2>Wi-Fi Setup</h2>

        <form>
            <div class="inputBox">
                <input type="text" name="ssid" id="ssid" required="required">
                <label for="ssid">Wi-Fi SSID</label>
            </div>
            <div class="inputBox">
                <input type="password" name="password" id="password" required="required">
                <label for="password">Wi-Fi Passport</label>
            </div>
            <input type="submit" value="Submit">
        </form>
    </div>


</body>
</html>
)====="; 

void webSocketEvent(uint8_t num, WStype_t type, uint8_t * payload, size_t length) {
  if(type == WStype_TEXT){
    scheduleId = (int)atoi((const char*) & payload[0]);  

    Serial.println("ScheduleId:" + scheduleId);
  }
}

void accessPointInit() {
  Serial.println("Configuring access point...");
    /* You can remove the password parameter if you want the AP to be open. */
    WiFi.softAP("SmartWatcherAP");
    //WiFi.softAP(ssid, password);
  
    IPAddress myIP = WiFi.softAPIP();
    Serial.print("AP IP address: ");
    Serial.println(myIP);
    server.on("/", []() {
      server.send_P(200, "text/html", rootPage);
    });
  
   //server.on("/WifiSetup", handleWiFiConnect);
    
   server.begin();
   webSocket.begin();
   webSocket.onEvent(webSocketEvent);
  return;
}

void displayText(String text){
    display.clearDisplay();
    
    display.setTextSize(2);
    display.setTextColor(WHITE);
    display.setCursor(0,0);
    display.clearDisplay();
    display.println(text);
    display.display();

    delay(2000);
    display.clearDisplay();
        delay(100);
}

void connectToWifi() {
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);

  display.clearDisplay();
  String line = "CONNECTING TO NETWORK";
  drawOnDisplay(line);
  int elapsed = millis();
  String dots = ".";
 
  while (WiFi.status() != WL_CONNECTED) {
    elapsed = millis();
    
    delay(500);
    Serial.print(".");
    dots += ".";    
    displayText(line + dots);
    
    if (elapsed - millis() > 10000) {
      display.clearDisplay();   
      accessPointInit(); 
      // dots = ".";  
      // drawOnDisplay(line + dots);    
      delay(10);

      break;
    }    
  }

   server.begin();
   webSocket.begin();
   webSocket.onEvent(webSocketEvent);
}

void setup()
{
  //  ************  INITIALIZE OLED ************
  //  Serial.begin(9600);60
  Serial.begin(115200);

  // by default, we'll generate the high voltage from the 3.3v line internally! (neat!)
  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);  // initialize with the I2C addr 0x3D (for the 128x64)
  // init done
  
  // Show image buffer on the display hardware.
  // Since the buffer is intialized with an Adafruit splashscreen
  // internally, this will display the splashscreen.
  display.display();
  delay(2000);

  // Clear the buffer.
  display.clearDisplay();

  //  ******************  INITIALIZE FINGERPRINT SCANNER  ******************

  //Serial.begin(115200);
  //Serial.begin(9600); //set up Arduino's hardware serial UART
  delay(100);
  fps.Open();         //send serial command to initialize fps
  fps.SetLED(true);   //turn on LED so fps can see fingerprint

  //  ******************  INITIALIZE ESP32  ******************
  Serial.println();
  Serial.println();
  Serial.print("Connecting to ");
  Serial.println(ssid);

  /* Explicitly set the ESP8266 to be a WiFi-client, otherwise, it by default,
     would try to act as both a client and an access-point and could cause
     network-issues with your other WiFi-devices on your WiFi-network. */

//   server.begin();
//   webSocket.begin();
//   webSocket.onEvent(webSocketEvent);
     
    connectToWifi();

    if(WiFi.status() == WL_CONNECTED) {
      displayText("WiFi connected");
      
      delay(1000);
      Serial.println("");
      Serial.println("WiFi connected");
  
      displayText("IP address: ");
  
      Serial.println("IP address: ");
      display.setTextSize(2);
      display.setTextColor(WHITE);
      display.setCursor(0,0);
      display.clearDisplay();
      display.println(WiFi.localIP());
      display.display();
      
      Serial.println(WiFi.localIP());  
    }
      

  delay(5000);
  pinMode(D0, INPUT);  
}

//  OLED DISPLAY METHODS/FUNCTIONS

void noNetwork(){
  display.clearDisplay();
  display.drawBitmap(0, 0,  networkTower, 128, 64, 1);
  //display.drawBitmap(32.0, thumbs_down, 64.32, WHITE);
  display.display();
  
  delay(2000);

    // Clear the buffer.
  display.clearDisplay();

  
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.setCursor(10,0);
  display.clearDisplay();
  display.println("NO WI-FI COVERAGE");
  display.display();
  
  return;
}



void denied(){
  display.clearDisplay();
  display.drawBitmap(0, 0,  thumbs_down, 128, 64, 1);
  //display.drawBitmap(32.0, thumbs_down, 64.32, WHITE);
  display.display();
  
  delay(2000);

    // Clear the buffer.
  display.clearDisplay();

  
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.setCursor(10,0);
  display.clearDisplay();
  display.println("DENIED");
  display.display();
  
  return;
}

void connecting() {
  display.clearDisplay();

  String line = "CONNECTING";

  int elapsed = millis();

  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.setCursor(10,0);
  display.clearDisplay();
  display.println(line);
  display.display();

  while(elapsed > 5000){
    display.clearDisplay();
    display.setTextSize(2);
    display.setTextColor(WHITE);
    display.setCursor(0,0);
    display.clearDisplay();


    line += ".";
    
    display.println(line);
    display.display();

    elapsed = millis();

    delay(1000);    
  }
  elapsed = 0;
    
  return;
}

void connectionEstablished(){
  
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.setCursor(16,0);
  display.clearDisplay();
  display.println("CONNECTED");
  display.display();

  delay(2000);

    // Clear the buffer.
  display.clearDisplay();
  
  return;
}

void allowed() {
  display.clearDisplay();
  display.drawBitmap(0, 0,  thumbs_up, 128, 64, 1);
  //display.drawBitmap(32.0, thumbs_down, 64.32, WHITE);
  display.display();
  
  delay(2000);

    // Clear the buffer.
  display.clearDisplay();


  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.setCursor(16,0);
  display.clearDisplay();
  display.println("SUCCESS");
  display.display();

  return;
}

void sendRequest(int sensorId) {

  Serial.print("connecting to ");
  Serial.println(host);

  // Use WiFiClient class to create TCP connections
  WiFiClient client;
  const int httpPort = 80;
  if (!client.connect(host, httpPort)) {
    Serial.println("connection failed");

  noNetwork();
    
    return;
  }

  // We now create a URI for the request
  //String url = "http://smartwatch-dev.us-east-2.elasticbeanstalk.com/Register/RegisterUser?sensorId=";
  String url = "http://192.168.4.2/Register/RegisterUser?sensorId=";
  //String url = "http://localhost:9855/Register/RegisterUser?sensorId=";

  url += (sensorId + 1);

  //  https://docs.microsoft.com/en-us/aspnet/core/signalr/hubs?view=aspnetcore-3.1
  //String url = "http://web-smartauthenticator-dev.us-east-2.elasticbeanstalk.com/Register/RegisterUser?sensorId=";
  //url += sensorId;

  Serial.print("Requesting URL: ");
  Serial.println(url);

  // This will send the request to the server
  client.print(String("GET ") + url + " HTTP/1.1\r\n" +
               "Host: " + host + "\r\n" +
               "Connection: close\r\n\r\n");
  unsigned long timeout = millis();

  display.clearDisplay();

  String line = "CONNECTING";

  displayText(line);
  
  while (client.available() == 0) {

    display.clearDisplay();
    
    line += ".";
    
    displayText(line);
    
    if (millis() - timeout > 5000) {

      display.clearDisplay();
    
      String error = ">>> Client Timeout !";
    
      displayText(error);
        
      Serial.println(error);
      client.stop();
  
      denied();
      
      return;
    }
  }

  line = "";

  // Read all the lines of the reply from server and print them to Serial
  while (client.available()) {
    line = client.readStringUntil('\r');
    Serial.print(line);
  }

  Serial.println();
  Serial.println("closing connection");


  //  Parsing the data from the server
  //  StaticJsonBuffer<200> jBuffer; 
  //  JsonObject& jObject = jBuffer.parseObject(line);
  
  //    String fullname = jObject["fullName"];
  //    String message = jObject["message"];
  //
  //    displayText("Welcome " + fullname);

  displayText("Welcome");

  //displayText(message); 

  if(line != "")
  {
    allowed();
  }

  return;
}

void broadcastFingerId(int id){
  String json = "{\"sensorId\":";
  json += id;
  json += ",\"scheduleId\":";
  json += scheduleId;
  json += "}";

  webSocket.broadcastTXT(json.c_str(), json.length());
}

void authenticate() {

  // Identify fingerprint test
  if (fps.IsPressFinger())
  {
    fps.CaptureFinger(false);
    int id = fps.Identify1_N();
    
       /*Note:  GT-521F52 can hold 3000 fingerprint templates
                GT-521F32 can hold 200 fingerprint templates
                 GT-511C3 can hold 200 fingerprint templates. 
                GT-511C1R can hold 20 fingerprint templates.
       Make sure to change the id depending on what
       model you are using */
    if (id <200) //<- change id value depending model you are using
    {//if the fingerprint matches, provide the matching template ID
      Serial.print("Verified ID:");
      Serial.println(id);

      displayText("Verified");

      delay(100);

//Serial.print("Sending sensor ID:"+ String(id) +" to server.");

      Serial.print("Sending sensor ID:");
      Serial.print(id);
      Serial.println(" to server.");

      delay(100);

      broadcastFingerId(id);
      //sendRequest(id);      
    }
    else
    {
      //if unable to recognize
      Serial.println("Finger not found");
      delay(100);
      displayText("Finger not found");

      denied();
    }
  }
  else
  {
    Serial.println("Please press finger");

    displayText("Present finger");
  }
  
  delay(100);
}

//****************************************************************************
bool canRefresh = false;
bool isEnrolling = false;
bool shouldNotify = false;
void enroll()
{
  // Enroll test

  // find open enroll id
  int enrollid = 0;
  bool usedid = true;
  while (usedid == true)
  {
    usedid = fps.CheckEnrolled(enrollid);
    if (usedid==true) enrollid++;
  }
  fps.EnrollStart(enrollid);

  // enroll
  Serial.print("Press finger to Enroll #");
  Serial.println(enrollid);
  
  displayText("Press finger to Enroll #");
     display.setTextSize(2);
      display.setTextColor(WHITE);
      display.setCursor(0,0);
      display.clearDisplay();
      display.println(enrollid);
      display.display();

  while(fps.IsPressFinger() == false){ 
    delay(100);
  
    if(digitalRead(13) == LOW){
    Serial.println("Button pressed");  
    isEnrolling = !isEnrolling;    

    shouldNotify = true;
    break;
  }

//    if(digitalRead(D7) == HIGH){
//        digitalWrite(D0, !digitalRead(D0));
//    }

  if(digitalRead(D0) == LOW){
    authenticate();  
  }
  else{
    enroll();
  }
  
  }
  bool bret = fps.CaptureFinger(true);
  int iret = 0;
  if (bret != false)
  {
    Serial.println("Remove finger");
    fps.Enroll1(); 
    while(fps.IsPressFinger() == true) {
      delay(100);
      if(digitalRead(13) == LOW) {
        Serial.println("Button pressed");  
        
        isEnrolling = !isEnrolling;    
    
        shouldNotify = true;
        break;
      }
    }
    
    Serial.println("Press same finger again");
    displayText("Press same finger again");
    
    while(fps.IsPressFinger() == false) delay(100);
    bret = fps.CaptureFinger(true);
    
    if (bret != false)
    {
      Serial.println("Remove finger");
      displayText("Remove finger");
      
      fps.Enroll2();
          while(fps.IsPressFinger() == true) {
      delay(100);
      if(digitalRead(13) == LOW){
        Serial.println("Button pressed");  
        isEnrolling = !isEnrolling;    
    
        shouldNotify = true;
        break;
      }
    }
      Serial.println("Press same finger yet again");
      displayText("Press same finger yet again");
      
      while(fps.IsPressFinger() == false) { 
        delay(100);
  
        if(digitalRead(13) == LOW) {
          Serial.println("Button pressed");  
          isEnrolling = !isEnrolling;    
      
          shouldNotify = true;
          break;
        }      
      }
      
      bret = fps.CaptureFinger(true);
      
      if (bret != false)
      {
        Serial.println("Remove finger");
        iret = fps.Enroll3();
        if (iret == 0)
        {
          Serial.println("Enrolling Successful");
          displayText("Enrolling Successful");
        }
        else
        {
          Serial.print("Enrolling Failed with error code:");          
          Serial.println(iret);

          displayText("Enrolling Failed with error code:");
          display.setTextSize(2);
          display.setTextColor(WHITE);
          display.setCursor(0,0);
          display.clearDisplay();
          display.println(iret);
          display.display();
        }
      }
      else Serial.println("Failed to capture third finger");
    }
    
    else Serial.println("Failed to capture second finger");
  }
  else Serial.println("Failed to capture first finger");
}


void loop()
{
    if(WiFi.status() == WL_CONNECTED) {
      if(digitalRead(D0) == LOW) 
      {
        authenticate();  
      }
      else 
      {
        enroll();
      }   
    }

    webSocket.loop();
    server.handleClient();
}
